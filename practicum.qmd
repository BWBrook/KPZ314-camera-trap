---
title: "KPZ314 Camera-trap Practical"
format: html
execute:
  echo: true
---

```{r setup, include=FALSE}
targets::tar_config_set(script = "_targets.R")
targets::tar_source("R")

# auto‑build if the cache is empty
if (!targets::tar_exist_objects(names = "raw")) {
  message("Building targets (~3‑5 min on fresh clone)…")
  targets::tar_make()
}

raw            <- targets::tar_read(raw)
site           <- targets::tar_read(site)
taxa           <- targets::tar_read(taxa)
alpha          <- targets::tar_read(alpha)
comm           <- targets::tar_read(comm)
beta_bc        <- targets::tar_read(beta_bc)
fig_heat       <- targets::tar_read(fig_heat)
fig_heat_bc    <- targets::tar_read(fig_heat_bc)
fig_heat_jac   <- targets::tar_read(fig_heat_jac)
fig_nmds       <- targets::tar_read(fig_nmds)
fig_nmds_jac   <- targets::tar_read(fig_nmds_jac)
nmds_stats     <- targets::tar_read(nmds_stats)
fig_site_map   <- targets::tar_read(fig_site_map)
fig_gap        <- targets::tar_read(fig_gap)
gamma_all      <- targets::tar_read(gamma_all)
gamma_region   <- targets::tar_read(gamma_region)
rare_region    <- targets::tar_read(rare_region)
rare_raw       <- targets::tar_read(rare_raw)
beta_permanova <- targets::tar_read(beta_permanova)
fig_sp_trends  <- targets::tar_read(fig_sp_trends)
rai            <- targets::tar_read(rai)
tab_effort     <- targets::tar_read(tab_effort)
alpha_ci       <- targets::tar_read(alpha_ci)
gamma_by_habitat <- targets::tar_read(gamma_by_habitat)
gamma_all_ci     <- targets::tar_read(gamma_all_ci)

# GLM module objects
glm_diag_all     <- targets::tar_read(glm_diag_all)
glm_irrs_all     <- targets::tar_read(glm_irrs_all)
fig_glm_coef     <- targets::tar_read(fig_glm_coef)
fig_glm_pd_type  <- targets::tar_read(fig_glm_pd_type)
```

## 1. Orientation

**Look at the raw, expert‑checked data table.**

```{r}
dplyr::glimpse(raw)
```

> **TASK 1.0** Think about why the data are encoded in this way.

### 1.1 Map of camera sites

```{r}
fig_site_map
```

> **TASK 1.1** The sites are clearly separated spatially. Is this the only relevant difference?

---

## 2. Independent events and effort

We treat “independent events” as detections separated by at least a configurable gap. Below, explore how site‑level metrics change across gap values (1, 5, 10, 30 minutes).

```{r}
fig_gap
```

Sampling effort affects interpretation, so we compute RAIs per 100 trap‑nights and provide the effort manifest for transparency.

```{r}
tab_effort
```

```{r}
head(rai, 8)
```

> **TASK 2.1** Pick a gap that balances independence and sample size for this fauna. Justify briefly (≤ 40 words).

---

## 3. Site‑level diversity

**Inspect alpha‑diversity metrics for all sites.**

```{r}
# Offset counts by excluding ubiquitous 'unknown' class: subtract 1
alpha_adj <- dplyr::mutate(alpha,
  richness = pmax(richness - 1, 0),
  chao1    = pmax(chao1 - 1, 0)
)

# Panel 1: abundance-like metrics (counts)
alpha_long_counts <- tidyr::pivot_longer(
  dplyr::select(alpha_adj, site, richness, chao1),
  -site, names_to = "metric", values_to = "value"
)

ggplot2::ggplot(alpha_long_counts, ggplot2::aes(x = metric, y = value)) +
  ggplot2::geom_boxplot()
```

```{r}
# Panel 2: entropy/evenness metrics
alpha_long_entropy <- tidyr::pivot_longer(
  dplyr::select(alpha_adj, site, pielou, shannon, simpson),
  -site, names_to = "metric", values_to = "value"
)

ggplot2::ggplot(alpha_long_entropy, ggplot2::aes(x = metric, y = value)) +
  ggplot2::geom_boxplot()
```

Hill numbers provide a unified view of diversity: q=0 is richness, q=1 is the effective number of species from Shannon (exp[H]), and q=2 is the inverse Simpson (dominance‑sensitive).

```{r}
# Bootstrap 95% CIs for Hill numbers and Pielou (per site)
knitr::kable(head(alpha_ci, 12), caption = "Alpha diversity (Hill) with 95% CIs (first 12 rows)")
```

> **TASK 3.1** Choose one site whose Shannon index is notably high or low. State an ecological hypothesis to explain the pattern (≤ 40 words).

### 3.2  Total (γ) diversity

```{r}
# Subtract 1 to discount the 'unknown' species placeholder
gamma_all_adj    <- gamma_all - 1L
gamma_region_adj <- dplyr::mutate(gamma_region, gamma = gamma - 1L)

gamma_all_adj     # scalar (adjusted)
gamma_region_adj  # by type (adjusted)

# Habitat-level gamma (Hill numbers) with 95% CIs
knitr::kable(gamma_by_habitat, caption = "Habitat-level gamma diversity (Hill) with bootstrap CIs")
```
> **TASK 3.2** How much of the γ diversity is captured in wet vs dry sites? (≤ 30 words)

### 3.3  Sampling sufficiency

```{r}
rare_raw
```

> **TASK 3.3.1** Are some of the camera sites undersampled? (≤ 30 words)

```{r}
rare_region
```

Sampling sufficiency and coverage: the endpoints on each rarefaction curve show the observed richness and its estimated coverage (S_obs/Chao1). Closer to 1 implies better sampling completeness.

> **TASK 3.3.2** Do the wet and dry curves suggest similar sampling completeness across habitats? Explain in ≤ 40 words.

---

## 4. Community turnover

Bray–Curtis (abundance) and Jaccard (presence–absence) emphasise different aspects of community turnover. Report results for both: abundance patterns (dominance) vs composition (which species are present).

### 4.1  Within-habitat dissimilarities and community structure

```{r}
fig_heat_bc
```

```{r}
fig_heat_jac
```

```{r}
cat(turnover_caption())
```

```{r}
plotly::ggplotly(fig_nmds)
```

```{r}
fig_nmds_jac
```

```{r}
knitr::kable(nmds_stats, caption = "NMDS fit statistics (stress) for each distance")
```

> **TASK 4.1** Name two clusters of sites that appear compositionally similar. Suggest one abiotic driver that could explain the pattern (≤ 40 words).

### 4.2  Are wet vs dry communities distinct (location) and equally dispersed?

```{r}
beta_permanova
```

Report R² (effect size) and permutation p for each distance. If `dispersion p < 0.05`, then groups differ in spread; interpret R² as partly/mostly driven by dispersion rather than centroid separation (location).

---

## 5. Habitat selection (effort‑offset GLMs)

We fit effort‑offset GLMs for five focal taxa with sensible family selection (Poisson ⇒ quasi/NB if overdispersed). Numeric covariates are z‑scored, so IRRs are per +1 SD. Models include a log(trap_nights) offset.

```{r}
knitr::kable(glm_diag_all, caption = "GLM diagnostics (family, dispersion, sites)")
```

```{r}
knitr::kable(glm_irrs_all, caption = "Incidence Rate Ratios (IRR) with 95% Wald CIs")
```

If the diagnostics table notes “type dropped … separation”, inference on wet vs dry failed for that species because all events occurred in one habitat. This is a common issue for rare taxa; we drop `type` and proceed with other covariates.

```{r}
# one forest plot per species
for (p in fig_glm_coef) print(p)
```

```{r}
# partial dependence for wet vs dry
for (p in fig_glm_pd_type) print(p)
```

> TASK 5.1 Pick one species and interpret the `type` IRR (wet vs dry) with its 95% CI in ≤ 35 words.
>
> TASK 5.2 Which habitat covariate has the strongest effect (IRR farthest from 1)? Interpret it per +1 SD in ≤ 35 words.

---

### 4.3  Species spotlight

```{r}
fig_sp_trends
```

> **TASK 4.3** Which habitat records more possum events? Suggest one ecological driver (≤ 40 words).

---

## 6. Trait exploration (stretch goal)

**Link alpha metrics to species traits (from the taxa table).**

```{r}
# Example structure view (joined alpha + site metadata)
alpha_site <- dplyr::left_join(alpha, site, by = "site")
utils::str(alpha_site)
```

> **TASK 5.1** If larger‑bodied taxa are more detectable, what pattern would you expect in the alpha metrics? Test it with a quick plot or summary, and comment (≤ 50 words).

---

## 7. Reflection

> **TASK 6.1** In ≤ 50 words, reflect on one limitation or source of bias in using camera‑trap data for community‑level inference in Tasmanian fauna.

---

## 8. Free Exploration

You can load any pipeline object into your R environment and explore it.

**For example:**

```{r}
# Assign the 'alpha' site diversity table to your workspace
alpha_local <- targets::tar_read(alpha)

# view the whole table in RStudio
alpha_local
```

**Try these ideas:**

* **Compare any two objects**
  e.g. plot Chao1 vs. Shannon diversity for all sites

  ```{r}
  alpha_tbl <- targets::tar_read(alpha)
  plot(alpha_tbl$chao1, alpha_tbl$shannon,
       xlab = "Chao1", ylab = "Shannon", pch = 16)
  ```

* **Investigate site metadata**

  ```{r}
  site_tbl <- targets::tar_read(site)
  summary(dplyr::select(site_tbl, type, leaf_litter, cwd, can_foliage))
  ```

* **Make a custom plot**

  ```{r}
  taxa_tbl <- targets::tar_read(taxa)
  ggplot2::ggplot(dplyr::filter(taxa_tbl, !is.na(status) & status != "na"),
                  ggplot2::aes(x = status, fill = status)) +
    ggplot2::geom_bar(show.legend = FALSE) +
    ggplot2::labs(title = "Taxon status in Tasmanian fauna",
        x = "Status", y = "Frequency") +
    ggplot2::theme_minimal()
  ```

> **TASK 7.1** Are native or introduced taxa more common in this camera-trap dataset? What does this suggest about Tasmania’s fauna?

* **Re-run a helper function yourself**

  Try feeding a subset of data to `calc_alpha()` or `build_comm_matrix()`.

  ```{r}
  # For interactive use of helpers:
  source("R/helpers_metrics.R")

  joined <- targets::tar_read(joined)
  custom <- joined[joined$type == "dry", ]
  calc_alpha(custom)
  ```

**Or try anything else**: every object from the workflow is just a data frame or matrix you can inspect, plot, or save!

---

> **Bonus:** In the R console, run `tar_manifest()` to see all available pipeline objects, or use `ls()` to see what’s loaded into your workspace.

---

## 9. Your Own Analysis

Write a short script or chunk below where you try something new with the data—anything goes!

```{r}

# Your code here!

```

---

## 9. “In-console” play

After knitting, you can open the R console, load the project, and call `tar_read()` for any target, or `source("R/helpers_metrics.R")` to get all helpers.

For truly unchained analysis: create an `explore.R` or `scratch.Rmd` and go free-form!
